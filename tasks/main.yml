---

- name: 'Fetch ec2 metatdata.'
  ec2_metadata_facts:
  when: 'aws_account is not defined'

- set_fact:
    iay_imports: []

- name: 'Make temp directory for terraform run.'
  tempfile:
    path: '{{ iay_tempdir.path|default(omit) }}'
    prefix: '{{ iay_tempdir.prefix|default(omit) }}'
    state: 'directory'
    suffix: '{{ iay_tempdir.suffix|default(omit) }}'
  register: 'iay_tempdir'
  when: 'iay_tempdir is not defined
      or iay_tempdir.path is not defined
      or iay_tempdir.persist is not defined
      or not iay_tempdir.persist'

- block:

    - include_tasks: 'providers_add.yml'
      loop: '{{ iay|dict2items }}'
      loop_control:
        loop_var: 'p'

    - include_tasks: 'terraform_apply.yml'
      vars:
        action: '{{ iay_action }}'

    - file:
        path: '{{ path }}'
        state: 'absent'
      when: 'not iay_tempdir.persist|default(false)'

  vars:
    path: '{{ iay_tempdir.path }}'
